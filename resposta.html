<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resposta - Quem √© esse Pok√©mon?</title>

  <link rel="icon" type="image/png" href="img/mike_anotando2.png">
  <link rel="shortcut icon" type="image/png" href="img/mike_anotando2.png">
  <link rel="apple-touch-icon" href="img/mike_anotando2.png">

  <style>
    :root {
      --cor-dourado: #d1a720;
      --cor-fundo: #1a1a1a;
      --cor-card: rgba(40, 35, 25, 0.95);
      --cor-texto: #f5f5f5;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height:100%; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, rgba(20,20,20,0.85), rgba(40,30,20,0.85)),
                  url("https://i.imgur.com/vATNRmF.png") no-repeat center center fixed;
      background-size: cover;
      color: var(--cor-texto);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      padding: 40px;
      min-height: 100vh;
      flex-wrap: wrap;
    }

    .card {
      background: var(--cor-card);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.6);
      text-align: center;
      width: 350px;
    }

    h2 {
      color: var(--cor-dourado);
      margin-bottom: 20px;
    }

    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
    }

    button {
      background: var(--cor-dourado);
      color: #000;
      border: none;
      padding: 12px;
      margin-top: 10px;
      width: 100%;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover { background: #ffcc33; transform: scale(1.03); }

    #resultado, #quizCard {
      display: none;
    }

    #pokemonNome {
      font-size: 1.6rem;
      font-weight: bold;
      color: var(--cor-dourado);
      margin-top: 12px;
      text-shadow: 0 0 8px #000;
    }

    #pokemonImg {
      margin-top: 15px;
      max-width: 250px;
      width: 100%;
      transition: transform .25s ease, filter .25s ease;
    }

    /* efeito discreto para shinies */
    .shiny-glow {
      animation: shinyPulse 1.6s infinite;
      filter: drop-shadow(0 0 14px rgba(255,215,90,0.9));
    }

    @keyframes shinyPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    #pergunta { font-weight: bold; margin-bottom: 12px; text-align: left; }
    #resposta { color: var(--cor-dourado); font-size: 1.1rem; margin-bottom: 10px; text-align: left; }
    #explicacao { font-size: 0.9rem; opacity: 0.9; text-align:left; }

    .small {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-top: 8px;
    }

    .row { display:flex; gap:8px; align-items:center; justify-content:center; margin-top:8px; }
    label.inline { font-size:0.9rem; cursor:pointer; }
  </style>
</head>
<body>
  <div class="card" id="loginCard">
    <h2>Login Organizador</h2>
    <input type="text" id="login" placeholder="Usu√°rio">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="fazerLogin()">Entrar</button>
    <p id="erro" style="color:red; display:none;">Usu√°rio ou senha incorretos!</p>
  </div>

  <div class="card" id="resultado" aria-live="polite">
    <h2>Resultado</h2>
    <p>O Pok√©mon sorteado foi:</p>
    <div id="pokemonNome">‚Äî</div>
    <img id="pokemonImg" alt="Pok√©mon revelado" src="" />
    <div class="row" style="justify-content:space-between;">
      <div style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="forceShiny" />
        <label for="forceShiny" class="inline">For√ßar Shiny (teste)</label>
      </div>
      <div style="text-align:right;">
        <button onclick="revelarOutro()">üîÑ Recarregar</button>
      </div>
    </div>

    <div class="small" id="metaInfo"></div>

    <br>
    <button onclick="logout()">Sair</button>
  </div>

  <div class="card" id="quizCard">
    <h2>Quiz Pok√©mon</h2>
    <p id="pergunta"></p>
    <p id="resposta"></p>
    <p id="explicacao"></p>
    <button onclick="novaPergunta()">üîÑ Nova Pergunta</button>
  </div>

  <script>
    // ---------- CONFIGURA√á√ÉO ----------
    // Taxa padr√£o de Shiny (1/4096 como nos jogos mais recentes).
    // Voc√™ pode alterar para 0.5 (50%) para testes r√°pido,
    // ou para 1/4096 para comportamento "real".
    const SHINY_RATE = 1 / 4096;

    const SECRET_KEY = "MikeOMacacoefoda2024";

    // ---------- UTIL ----------
    function tryJSONParse(s) {
      try { return JSON.parse(s); } catch { return null; }
    }

    function decrypt(text) {
      try {
        // Mantive a sua fun√ß√£o de decrypt original (atob + xor)
        const decoded = decodeURIComponent(escape(atob(text)));
        return decoded.split('').map((c,i)=>
          String.fromCharCode(c.charCodeAt(0) ^ SECRET_KEY.charCodeAt(i % SECRET_KEY.length))
        ).join('');
      } catch {
        return null;
      }
    }

    function capitalize(str) {
      if (!str) return str;
      return str[0].toUpperCase() + str.slice(1);
    }

    // ---------- LOGIN / SESS√ÉO ----------
    function fazerLogin() {
      const usuario = document.getElementById("login").value;
      const senha = document.getElementById("senha").value;

      if (usuario === "OrganizadorDeEventos" && senha === "MikeOMacaco3Foda") {
        sessionStorage.setItem("adminLogado", "true"); // üîë sess√£o tempor√°ria
        mostrarResultado();
        mostrarQuiz();
      } else {
        const erro = document.getElementById("erro");
        erro.style.display = "block";
        setTimeout(()=> erro.style.display = "none", 2500);
      }
    }

    function logout() {
      sessionStorage.clear();
      location.reload();
    }

    // ---------- MOSTRAR RESULTADO (COM SHINY) ----------
    async function mostrarResultado() {
      document.getElementById("loginCard").style.display = "none";
      document.getElementById("resultado").style.display = "block";

      const respostaCripto = localStorage.getItem("pokemonResposta");
      if (!respostaCripto) {
        document.getElementById("pokemonNome").innerText = "Nenhum Pok√©mon sorteado ainda!";
        document.getElementById("pokemonImg").src = "";
        return;
      }

      const pokemonRaw = decrypt(respostaCripto);
      if (!pokemonRaw) {
        document.getElementById("pokemonNome").innerText = "Erro ao descriptografar.";
        document.getElementById("pokemonImg").src = "";
        return;
      }

      // For√ßar shiny pelo checkbox (√∫til para testes)
      const forceShinyCheckbox = document.getElementById("forceShiny");
      const forcedShiny = forceShinyCheckbox && forceShinyCheckbox.checked;

      // Decide se √© shiny (aleat√≥rio) ou for√ßado
      const isShiny = forcedShiny ? true : (Math.random() < SHINY_RATE);

      const pokemonDisplayName = capitalize(String(pokemonRaw));
      document.getElementById("pokemonNome").innerText = pokemonDisplayName + (isShiny ? " ‚ú® (Shiny)" : "");

      // Informa√ß√£o meta (para debug/admin)
      const meta = document.getElementById("metaInfo");
      meta.innerText = `Shiny rate: ${SHINY_RATE} ‚Äî For√ßado: ${forcedShiny ? 'sim' : 'n√£o'}`;

      // Busca o ID no seu arquivo pokemons/pokemon.json de forma flex√≠vel
      try {
        const res = await fetch("pokemons/pokemon.json");
        const data = await res.json();

        // Tenta encontrar por v√°rias estrat√©gias
        let entry = null;
        const keyExact = data[pokemonRaw];
        if (keyExact) entry = keyExact;

        const keyLower = data[pokemonRaw.toLowerCase()];
        if (!entry && keyLower) entry = keyLower;

        if (!entry) {
          // procura nos valores por propriedade 'name' ou 'nome' que case ignorando case
          entry = Object.values(data).find(e => {
            if (!e) return false;
            const possibleNames = [];
            if (typeof e === 'string') possibleNames.push(e);
            if (e.name) possibleNames.push(String(e.name));
            if (e.nome) possibleNames.push(String(e.nome));
            // algumas bases usam key como nome e valor como id (ex: "Pidgeot": 18)
            if (typeof e === 'number' || typeof e === 'string' && /^\d+$/.test(e)) return false;
            return possibleNames.some(n => n && n.toLowerCase() === pokemonRaw.toLowerCase());
          }) || null;
        }

        // se entry ainda null, tenta interpretar pokemonRaw como ID
        let id = null;
        if (entry) {
          id = entry.id || entry.numero || entry.number || entry.n || entry.dex || null;
        }

        if (!id) {
          // se pokemonRaw for um n√∫mero
          const maybeId = parseInt(pokemonRaw, 10);
          if (!isNaN(maybeId)) id = maybeId;
        }

        // se ainda sem id, tentamos encontrar objeto cujo chave seja o nome e valor seja n√∫mero
        if (!id) {
          for (const [k,v] of Object.entries(data)) {
            if (k.toLowerCase() === pokemonRaw.toLowerCase()) {
              if (typeof v === 'number' || (typeof v === 'string' && /^\d+$/.test(v))) {
                id = Number(v);
                break;
              }
            }
          }
        }

        // Se temos id, monta as URLs
        if (id) {
          const normalUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
          const shinyUrl  = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/shiny/${id}.png`;
          const imgEl = document.getElementById("pokemonImg");
          imgEl.classList.toggle("shiny-glow", isShiny);
          imgEl.src = isShiny ? shinyUrl : normalUrl;
          imgEl.alt = `${pokemonDisplayName} ${isShiny ? '(Shiny)' : ''}`;
        } else {
          // fallback visual quando n√£o encontra id: busca pelo nome na PokeAPI (opcional)
          // Aqui usamos uma imagem gen√©rica e mostramos aviso
          document.getElementById("pokemonImg").src = "";
          document.getElementById("pokemonImg").alt = "Imagem indispon√≠vel";
          meta.innerText += " ‚Äî ID do Pok√©mon n√£o encontrado no pokemons/pokemon.json";
        }
      } catch (err) {
        console.error("Erro ao carregar pokemons/pokemon.json:", err);
        document.getElementById("pokemonImg").src = "";
        document.getElementById("pokemonImg").alt = "Erro ao carregar imagem";
        document.getElementById("metaInfo").innerText = "Erro ao carregar dados do arquivo pokemons/pokemon.json";
      }
    }

    // para recarregar sem logout
    function revelarOutro() {
      // Apenas recarrega a p√°gina; mant√©m sess√£o admin
      if (sessionStorage.getItem("adminLogado") === "true") {
        // mant√©m estado checkbox for√ßar shiny
        const forced = document.getElementById("forceShiny").checked;
        // recalc: chamar mostrarResultado novamente
        mostrarResultado();
        // restaura checkbox (mostrarResultado n√£o altera)
        document.getElementById("forceShiny").checked = forced;
      } else {
        location.reload();
      }
    }

    // ---------- QUIZ ----------
    function mostrarQuiz() {
      document.getElementById("quizCard").style.display = "block";

      const perguntaSalva = sessionStorage.getItem("perguntaAtual");
      if (perguntaSalva) {
        preencherQuiz(JSON.parse(perguntaSalva));
      } else {
        sortearPergunta();
      }
    }

    function sortearPergunta() {
      fetch("perguntas/perguntas.json")
        .then(res => res.json())
        .then(data => {
          const lista = data.perguntas_respostas || data.perguntas || [];
          const sorteada = lista[Math.floor(Math.random() * lista.length)];
          sessionStorage.setItem("perguntaAtual", JSON.stringify(sorteada)); // salva
          preencherQuiz(sorteada);
        })
        .catch(err => {
          console.error("Erro ao carregar perguntas:", err);
          document.getElementById("pergunta").innerText = "Erro ao carregar perguntas.";
        });
    }

    function preencherQuiz(item) {
      if (!item) {
        document.getElementById("pergunta").innerText = "Nenhuma pergunta dispon√≠vel.";
        return;
      }
      document.getElementById("pergunta").innerText = item.pergunta || "Pergunta";
      document.getElementById("resposta").innerText = "Resposta: " + (item.resposta || "‚Äî");
      document.getElementById("explicacao").innerText = (item.explicacao || "") + (item.dex ? " (Dex: " + item.dex + ")" : "");
    }

    function novaPergunta() {
      sessionStorage.removeItem("perguntaAtual"); // libera para nova
      sortearPergunta();
    }

    // ---------- ONLOAD ----------
    window.onload = () => {
      // se admin ja logado, mostra resultado e quiz
      if (sessionStorage.getItem("adminLogado") === "true") {
        mostrarResultado();
        mostrarQuiz();
      }
      // permite for√ßar shiny durante testes (checkbox funcional)
      document.getElementById("forceShiny").addEventListener('change', () => {
        // atualizar a exibi√ß√£o atual quando trocar o checkbox
        if (sessionStorage.getItem("adminLogado") === "true") mostrarResultado();
      });
    };
  </script>
</body>
</html>
